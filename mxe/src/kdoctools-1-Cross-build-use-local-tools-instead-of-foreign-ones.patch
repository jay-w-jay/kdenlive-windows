This file is part of MXE.
See index.html for further information.

From 8df93ae02b150b672618f583f3c1accf6d623515 Mon Sep 17 00:00:00 2001
From: Vincent Pinon <vpinon@kde.org>
Date: Tue, 19 Jul 2016 09:08:03 +0200
Subject: [PATCH] Cross build: use local tools instead of foreign ones

---
 CMakeLists.txt     |  4 +++-
 src/CMakeLists.txt | 37 +++++++++++++++++++------------------
 2 files changed, 22 insertions(+), 19 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 1f656dd..7726df3 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -74,7 +74,9 @@ remove_definitions(-DQT_NO_CAST_FROM_ASCII)
 
 set(_kdoctoolsBootStrapping TRUE)
 set(KDOCTOOLS_CUSTOMIZATION_DIR "${CMAKE_CURRENT_BINARY_DIR}/src/customization/")
-if (WIN32)
+if (CMAKE_CROSSCOMPILING)
+    find_program(KDOCTOOLS_MEINPROC_EXECUTABLE meinproc5)
+elseif (WIN32)
     set(KDOCTOOLS_MEINPROC_EXECUTABLE          ${EXECUTABLE_OUTPUT_PATH}/${CMAKE_CFG_INTDIR}/meinproc5 )
 else ()
     set(KDOCTOOLS_MEINPROC_EXECUTABLE          ${CMAKE_CURRENT_BINARY_DIR}/src/meinproc5${CMAKE_EXECUTABLE_SUFFIX} )
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 6f903b5..522e9b6 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -57,12 +57,13 @@ install(TARGETS KF5XsltKde EXPORT KF5DocToolsTargets ${KF5_INSTALL_TARGETS_DEFAU
 
 ########### next target ###############
 
-# The cross compiling parts are commented out on purpose. Alex
+set_source_files_properties(xslt.cpp PROPERTIES COMPILE_FLAGS -DSIMPLE_XSLT )
+
 if (CMAKE_CROSSCOMPILING)
-#    set(IMPORT_MEINPROC5_EXECUTABLE "${KDE_HOST_TOOLS_PATH}/ImportMeinProc5Executable.cmake" CACHE FILEPATH "Point it to the export file of meinproc5 from a native build")
-#    include(${IMPORT_MEINPROC5_EXECUTABLE})
+    find_program(MEINPROC5_EXECUTABLE meinproc5)
+    add_executable(KF5::meinproc5 IMPORTED GLOBAL)
+    set_target_properties(KF5::meinproc5 PROPERTIES IMPORTED_LOCATION ${MEINPROC5_EXECUTABLE})
 else ()
-    set_source_files_properties(xslt.cpp PROPERTIES COMPILE_FLAGS -DSIMPLE_XSLT )
 
     if(MEINPROC_NO_KARCHIVE)
         add_definitions(-DMEINPROC_NO_KARCHIVE) #we don't have saveToCache when compiling without KArchive, which is used in xslt_kde.cpp
@@ -166,18 +167,18 @@ endforeach(_currentcustomizedir ${customizedir})
 
 ########### l10n xml helper ###############
 
-set( docbookl10nhelper_SRCS docbookl10nhelper.cpp )
-add_executable( docbookl10nhelper ${docbookl10nhelper_SRCS} )
-ecm_mark_nongui_executable( docbookl10nhelper )
-target_link_libraries( docbookl10nhelper Qt5::Core )
-
-add_custom_command( TARGET docbookl10nhelper POST_BUILD
-    COMMAND $<TARGET_FILE:docbookl10nhelper>
-    "${DOCBOOKXSL_DIR}" "${CMAKE_CURRENT_SOURCE_DIR}/customization/xsl"
-    "${CMAKE_CURRENT_BINARY_DIR}/customization/xsl"
-)
-
-# all-l10n.xml is generated by docbookl10nhelper
-install(FILES ${CMAKE_CURRENT_BINARY_DIR}/customization/xsl/all-l10n.xml
-    DESTINATION ${KDE_INSTALL_DATADIR_KF5}/kdoctools/customization/xsl/ )
+if (NOT CMAKE_CROSSCOMPILING)
+    set( docbookl10nhelper_SRCS docbookl10nhelper.cpp )
+    add_executable( docbookl10nhelper ${docbookl10nhelper_SRCS} )
+    ecm_mark_nongui_executable( docbookl10nhelper )
+    target_link_libraries( docbookl10nhelper Qt5::Core )
+    add_custom_command( TARGET docbookl10nhelper POST_BUILD
+        COMMAND $<TARGET_FILE:docbookl10nhelper>
+        "${DOCBOOKXSL_DIR}" "${CMAKE_CURRENT_SOURCE_DIR}/customization/xsl"
+        "${CMAKE_CURRENT_BINARY_DIR}/customization/xsl"
+    )
+    # all-l10n.xml is generated by docbookl10nhelper
+    install(FILES ${CMAKE_CURRENT_BINARY_DIR}/customization/xsl/all-l10n.xml
+        DESTINATION ${KDE_INSTALL_DATADIR_KF5}/kdoctools/customization/xsl/ )
+endif()
 
-- 
2.7.4

